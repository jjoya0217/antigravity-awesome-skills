"""
ë¸Œë¦¬í•‘ ë³´ê³ ì„œ ìƒì„± ëª¨ë“ˆ
Markdown í˜•ì‹ì˜ ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ ë³´ê³ ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
"""
import sys
import os
from datetime import datetime
from pathlib import Path
from typing import List, Dict, Optional

# Windows UTF-8 ì„¤ì •
if sys.platform == "win32":
    sys.stdout.reconfigure(encoding="utf-8", errors="replace")
    sys.stderr.reconfigure(encoding="utf-8", errors="replace")

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from config import REPORT_TITLE, get_today_output_dir


def generate_briefing_report(
    videos: List[Dict],
    notebooklm_analysis: Optional[str] = None,
) -> Path:
    """
    ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ Markdown ë³´ê³ ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

    Args:
        videos: íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ê°€ í¬í•¨ëœ ì˜ìƒ ë¦¬ìŠ¤íŠ¸
        notebooklm_analysis: NotebookLMì˜ ë¶„ì„ ê²°ê³¼ (ì„ íƒ)

    Returns:
        ìƒì„±ëœ ë³´ê³ ì„œ íŒŒì¼ ê²½ë¡œ
    """
    now = datetime.now()
    date_str = now.strftime("%Y-%m-%d")
    time_str = now.strftime("%H:%M")
    output_dir = get_today_output_dir()
    report_path = output_dir / f"{date_str}-briefing.md"

    lines = []

    # í—¤ë”
    lines.append(f"# ğŸ“‹ {REPORT_TITLE}")
    lines.append(f"**ë‚ ì§œ:** {date_str} | **ìƒì„± ì‹œê°:** {time_str}")
    lines.append(f"**ìˆ˜ì§‘ ì˜ìƒ:** {len(videos)}ê°œ\n")
    lines.append("---\n")

    # NotebookLM ë¶„ì„ ê²°ê³¼
    if notebooklm_analysis:
        lines.append("## ğŸ¤– AI ì¢…í•© ë¶„ì„ (NotebookLM)\n")
        lines.append(notebooklm_analysis)
        lines.append("\n---\n")

    # ì±„ë„ë³„ ì˜ìƒ ê·¸ë£¹í•‘
    channels = {}
    for v in videos:
        ch = v.get("channel_name", "Unknown")
        if ch not in channels:
            channels[ch] = []
        channels[ch].append(v)

    # ì˜ìƒ ìš”ì•½
    lines.append("## ğŸ“¹ ì±„ë„ë³„ ì˜ìƒ ìš”ì•½\n")

    for channel_name, channel_videos in channels.items():
        lines.append(f"### ğŸ“º {channel_name}\n")

        for v in channel_videos:
            title = v.get("title", "ì œëª© ì—†ìŒ")
            url = v.get("url", "")
            published = v.get("published", "")
            transcript = v.get("transcript", "")

            lines.append(f"#### [{title}]({url})\n")
            if published:
                lines.append(f"- **ê²Œì‹œì¼:** {published}")
            if transcript:
                lines.append(f"- **ìë§‰ ê¸¸ì´:** {len(transcript):,}ì ({v.get('transcript_language', '?')})")

                # íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ì—ì„œ í•µì‹¬ ë‚´ìš© ì¶”ì¶œ (ì²˜ìŒ 300ì)
                preview = transcript[:300].replace("\n", " ")
                lines.append(f"- **ë¯¸ë¦¬ë³´ê¸°:** {preview}...")
            lines.append("")

    # í†µê³„
    lines.append("---\n")
    lines.append("## ğŸ“Š ìˆ˜ì§‘ í†µê³„\n")
    lines.append(f"| í•­ëª© | ê°’ |")
    lines.append(f"|------|------|")
    lines.append(f"| ì±„ë„ ìˆ˜ | {len(channels)} |")
    lines.append(f"| ì´ ì˜ìƒ ìˆ˜ | {len(videos)} |")

    total_transcript_chars = sum(len(v.get("transcript", "")) for v in videos)
    lines.append(f"| ì´ ìë§‰ ê¸¸ì´ | {total_transcript_chars:,}ì |")

    transcript_success = sum(1 for v in videos if v.get("transcript"))
    lines.append(f"| ìë§‰ ì¶”ì¶œ ì„±ê³µ | {transcript_success}/{len(videos)} |")
    lines.append("")

    # í‘¸í„°
    lines.append("---\n")
    lines.append(f"*Generated by YouTube Daily Briefing Agent*")
    lines.append(f"*{now.strftime('%Y-%m-%d %H:%M:%S')}*")

    # íŒŒì¼ ì €ì¥
    content = "\n".join(lines)
    report_path.write_text(content, encoding="utf-8")

    print(f"ğŸ“„ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ: {report_path}")
    return report_path
